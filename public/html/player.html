<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="/js/peer.js"></script>
<script src="/js/jsmediatags.js"></script>
<!--<script src="//cdn.webrtc-experiment.com/RTCMultiConnection.js"></script>-->
<!--<script src="//cdn.webrtc-experiment.com/firebase.js"></script>-->

<!--<input type="file">-->
<!--<button id="openNewSessionButton" disabled>Open New Room</button>-->
<!--<br />-->

<ul>
    <li>
        <input type="file" id="files" name="files[]" multiple />
        <output id="playlist"></output>
    </li>
    <li>
        <!--<button class="play" id="play" name="play">Play</button>-->
        <!--<button class="stop" id="stop" name="stop">Stop</button>-->
        <audio controls="controls" autoplay="autoplay" id="player">
            <source src="http://webaudioapi.com/samples/audio-tag/chrono.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </li>
</ul>
<script>

    console.log("outer");
    $( document ).ready(function() {


        var files = [];

        // from http://www.html5rocks.com/en/tutorials/file/dndfiles/
        // Check for the various File API support.
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }


//        function handleFileSelect(evt) {
//            var files = evt.target.files; // FileList object
//
//            // files is a FileList of File objects. List some properties.
//            var output = [];
//            for (var i = 0, f; f = files[i]; i++) {
//                output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
//                        f.size, ' bytes, last modified: ',
//                        f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
//                        '</li>');
//            }
//            document.getElementById('playlist').innerHTML = '<ul>' + output.join('') + '</ul>';
//
//        });


//        var peer = new Peer('1234567', { host:'localhost', port: 3000, path: '/peerjs',
//        });

        var peer = new Peer({key: 'a3g2zb1cpmeipb9', id: '1234567'});

        var conn = peer.connect('1234567');

        conn.send("hello");

        peer.on('connect', function (data) {
            alert("connected");
        });


        conn.on('data', function (data) {
                    console.log(data);
                }
        );


        console.log(peer);
        console.log(conn);

//        var player = $('#player').get(0);
//        player.loop = true;
        var audioCtx = new AudioContext();
        var player = $("#player").get(0);
        var soundSource = audioCtx.createMediaElementSource(player);


        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        var gainNode = audioCtx.createGain();

        var distortion = audioCtx.createWaveShaper();


        function makeDistortionCurve(amount) {
            var k = typeof amount === 'number' ? amount : 50,
                    n_samples = 44100,
                    curve = new Float32Array(n_samples),
                    deg = Math.PI / 180,
                    i = 0,
                    x;
            for ( ; i < n_samples; ++i ) {
                x = i * 2 / n_samples - 1;
                curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
            }
            return curve;
        };

        distortion.curve = makeDistortionCurve(400);
        distortion.oversample = '4x';



        soundSource.connect(distortion);
        distortion.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        $('#play').click(function (e) {
            soundSource.resume();
        });

        $('#stop').click(function (e) {
            soundSource.suspend();
        });


        $('#files').change(function (e) {
//

                    var files = e.currentTarget.files;
                    console.log('file change');

                    file = files[0];

                    objectUrl = URL.createObjectURL(file);
                    $("#player").prop("src", objectUrl);
//            player.src = files[0];
                    console.log(files);

                    player.play();
                }
        )
    });


</script>
<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="/js/peer.js"></script>
<script src="/js/jsmediatags.js"></script>
<!--<script src="//cdn.webrtc-experiment.com/RTCMultiConnection.js"></script>-->
<!--<script src="//cdn.webrtc-experiment.com/firebase.js"></script>-->

<!--<input type="file">-->
<!--<button id="openNewSessionButton" disabled>Open New Room</button>-->
<!--<br />-->

<ul>
    <li>
        <input type="file" id="files" name="files[]" multiple />
        <output id="playlist"></output>
        <input type="number" id="distortion" name="distortion" title="distortion" value="400"/>
    </li>
    <li>
        <!--<button class="play" id="play" name="play">Play</button>-->
        <!--<button class="stop" id="stop" name="stop">Stop</button>-->
        <audio controls="controls" autoplay="autoplay" id="player">
            <source src="http://webaudioapi.com/samples/audio-tag/chrono.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </li>
</ul>


<style>
    #messages {
        border: 1px solid black;
        min-height: 20px;
    }
</style>
<div id="messages" contenteditable></div>


<script src="/js/common.js"></script>
<script src="/js/visualizer.js"></script>
<canvas></canvas>
<script>



    console.log("outer");
    $( document ).ready(function() {


        var files = [];

        // from http://www.html5rocks.com/en/tutorials/file/dndfiles/
        // Check for the various File API support.
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }


        var peer = new Peer({key: 'a3g2zb1cpmeipb9', id: '1234567'});

        var conn = peer.connect('1234567');

        conn.send("hello");

        peer.on('connect', function (data) {
            alert("connected");
        });


        conn.on('data', function (data) {
                    console.log(data);
                }
        );


        console.log(peer);
        console.log(conn);

//        var player = $('#player').get(0);
//        player.loop = true;
        var remoteDestination;

        var audioCtx = new AudioContext();
        var player = $("#player").get(0);
        var soundSource = audioCtx.createMediaElementSource(player);


        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        var gainNode = audioCtx.createGain();
        var distortion = audioCtx.createWaveShaper();
        var remoteDestination = audioCtx.createMediaStreamDestination();


        function makeDistortionCurve(amount) {
            var k = typeof amount === 'number' ? amount : 50,
                    n_samples = 44100,
                    curve = new Float32Array(n_samples),
                    deg = Math.PI / 180,
                    i = 0,
                    x;
            for ( ; i < n_samples; ++i ) {
                x = i * 2 / n_samples - 1;
                curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
            }
            return curve;
        };

        distortion.curve = makeDistortionCurve(0);
        distortion.oversample = '4x';



        soundSource.connect(distortion);
        distortion.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        gainNode.connect(remoteDestination);


        navigator.getUserMedia = function(x, y, z){
            console.log("I was called");
            return remoteDestination;
        };

        $('#distortion').change(function (e){

            console.log("changed distortion");
            distortion.disconnect();
            soundSource.disconnect();
            distortion = null;
            distortion = audioCtx.createWaveShaper();
            soundSource.connect(distortion);
            distortion.curve = makeDistortionCurve(e);
            distortion.connect(gainNode);
        });

        $('#play').click(function (e) {
            soundSource.resume();
        });

        $('#stop').click(function (e) {
            soundSource.suspend();
        });


        $('#files').change(function (e) {
//

                    var files = e.currentTarget.files;
                    console.log('file change');

                    file = files[0];
                    objectUrl = URL.createObjectURL(file);
                    $("#player").prop("src", objectUrl);
                    console.log(files);

                    player.play();
                }
        );

        var sample = new VisualizerSample(soundSource, audioCtx);



//
//        call.on('stream', function(remoteStream){
//            console.log(remoteStream);
//        })
    });


</script>

<script src="/js/rtc.min.js"></script>

<script>

    var rtcOpts = {
        room: 'test-room',
        signaller: 'https://switchboard.rtc.io'
    };

    var rtc = RTC(rtcOpts);

    var messageWindow = document.getElementById('messages');


    // Bind to events happening on the data channel
    function bindDataChannelEvents(id, channel, attributes, connection) {

        // Receive message
        channel.onmessage = function (evt) {
            messageWindow.innerHTML = evt.data;
        };

        // Send message
        messageWindow.onkeyup = function () {
            channel.send(this.innerHTML);
        };
    }

    function init(session) {
        session.createDataChannel('chat');
        session.on('channel:opened:chat', bindDataChannelEvents);
    }
    rtc.on('ready', init);


</script>
<!--<canvas id="c"></canvas>-->
<!--<script>-->
    <!--navigator.getUserMedia('audio', gotAudio);-->
    <!--var streamRecorder;-->
    <!--function gotAudio(stream) {-->
        <!--var microphone = context.createMediaStreamSource(stream);-->
        <!--var analyser = context.createAnalyser();-->
        <!--microphone.connect(analyser);-->
        <!--analyser.connect(context.destination);-->
        <!--requestAnimationFrame(drawAnimation);-->

        <!--streamRecorder = stream.record();-->
        <!--peerConnection.addStream(stream);-->
    <!--}-->
<!--</script>-->



<script>
//    document.querySelector('button').addEventListener('click', function() {
//        sample.togglePlayback()
//    });
</script>
